<!DOCTYPE html>
<html>
<head>
    <title>Test SVG Encoding Fix</title>
</head>
<body>
    <h1>Test SVG Encoding</h1>
    <button onclick="testEncoding()">Test Encoding Fix</button>
    <div id="result"></div>
    
    <script>
        async function testEncoding() {
            const resultDiv = document.getElementById('result');
            
            try {
                // Test with a simple request first
                const response = await fetch('http://localhost:3001/api/generate-plaque', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        url: 'https://open.spotify.com/track/4iV5W9uYEdYUVa79Axb7Rh',
                        style: 'minimal' 
                    })
                });
                
                if (response.ok) {
                    const svgContent = await response.text();
                    
                    // Test the fixed encoding
                    let svgDataUrl;
                    try {
                        // Convert UTF-8 to base64 safely
                        const utf8Bytes = new TextEncoder().encode(svgContent);
                        let binaryString = '';
                        for (let i = 0; i < utf8Bytes.length; i++) {
                            binaryString += String.fromCharCode(utf8Bytes[i]);
                        }
                        svgDataUrl = 'data:image/svg+xml;base64,' + btoa(binaryString);
                        resultDiv.innerHTML = `
                            <h3>‚úÖ Encoding Success!</h3>
                            <p>SVG content length: ${svgContent.length} characters</p>
                            <img src="${svgDataUrl}" alt="SVG Preview" style="border: 1px solid #ccc; max-width: 300px;">
                        `;
                    } catch (encodingError) {
                        console.log('Base64 encoding failed, using URL encoding instead:', encodingError.message);
                        svgDataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgContent);
                        resultDiv.innerHTML = `
                            <h3>‚ö†Ô∏è Base64 failed, using URL encoding</h3>
                            <p>Error: ${encodingError.message}</p>
                            <img src="${svgDataUrl}" alt="SVG Preview" style="border: 1px solid #ccc; max-width: 300px;">
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `<h3>‚ùå Server Error</h3><p>Status: ${response.status}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<h3>üö´ Connection Error</h3><p>${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
